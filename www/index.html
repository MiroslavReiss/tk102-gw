<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Live Jailbreak Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="shortcut icon" href="/static/images/silly-dragon-favicon.ico">
    <meta name="Description" content="Scarlett & Mohit's Live Jailbreak Tracker">
    <meta name="Keywords" content="jailbreak,jail,break,soton,southampton,uni,enactus,tracker,map,progress,updates,live,scarlett,mohit">
    <style>
        body {
                padding: 0;
                margin: 0;
        }
        html, body, #map {
                height: 100%;
        }
        .box {
                 position: absolute; 
                 background-color: white; 
                 border: 1px solid #0070a3; 
                 background-attachment:initial;
                 background-clip:initial;
                 background-color:rgb(255, 255, 255);
                 background-color:rgba(255, 255, 255, 0.85);
                 background-image:initial;
                 background-origin:initial;
                 background-position:initial;
                 background-repeat:initial;
        }
        #box-status {
                 position: absolute;
                 top: 10px;
                 right: 10px;
                 width: 400px;
                 max-width: 100%;
                 max-height: 70%;
                 overflow-y: auto;
                 padding-left: 20px;
                 padding-right: 20px;
                 padding-bottom: 20px;
                 font-family: Helvetica,"Lucida Grande",Verdana,Arial;
                 font-size: 12px;
        }
        .leaflet-tile-container img {
		-webkit-backface-visibility: hidden;
	}
        </style>
        <link rel="stylesheet" href="/static/css/leaflet.css" />
        <!--[if lte IE 8]><link rel="stylesheet" href="/static/css/leaflet.ie.css" /><![endif]-->
</head>
<body>
        <div id="map"></div>
        <div id="box-status" class="box">
                <h1 style="text-align:center;">Jail Break Live Tracking Map</h1>
                <h2 style="text-align:center;">Scarlett and Mohit are doing a Jail-Break from Southampton Uni to raise money for <a href="http://www.sifesouthampton.com/" target="_blank">Enactus</a>!</h2>
                <ul style="line-height: 1.8em;">
                <li>The idea is to get as far away from Southampton as possible without spending any money! Watch them go!</li>
                <li><b>Read more on <a href="http://www.dottyprojects.com/southampton-jail-break-2013/" target="_blank">Scarlett's Blog</a>!</b></li>
                <li><b>Sponsor them on Raise2Give!</b></li>
                <ul>
                <li><b><a href="https://www.raise2give.com/jail-break-southampton/scarlett-theron-rush" target="_blank">Scarlett's Page</a></b>&nbsp;-&nbsp;Currently £<span id="scarlettRaised"></span> Raised</li>
                <li><b><a href="https://www.raise2give.com/jail-break-southampton/mohit-gupta" target="_blank">Mohit's Page</a></b>&nbsp;-&nbsp;Currently £<span id="mohitRaised"></span> Raised</li>
                <li><b>Current Total Raised: £<span id="sumRaised"></span></b></li>
                </ul>
                </ul>
                Position last updated <span id="lupdated"></span>.
        </div>
    <script src="/static/js/leaflet.js"></script>
    <script src="/static/js/moment.min.js"></script>
    <script src="/static/js/jquery-1.10.2.min.js"></script>
    <script>
        var map = L.map('map').setView([50.673, -1.286], 4);
        var latest_id=-1;
        var lastMarker;
        var trackTail;
    
        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        sillyDragonIcon = L.icon({
            iconUrl: '/static/images/silly-dragon-map.ico',
            iconSize:     [64, 64], // size of the icon
            iconAnchor:   [32, 32], // point of the icon which will correspond to marker's location
        });
        
        initData();
        setInterval(refreshData,5*1000); // Refresh Data every 30s
        
        function initData() {
            $.ajax({
		        url: "/data.php",
		        type: "GET",
		        dataType: 'json',
		        success: function( data ) {
		            if(data[0].length!=0) { // Raised so far values
		                $("#scarlettRaised").text(data[0][0].toFixed(2));
		                $("#mohitRaised").text(data[0][1].toFixed(2));
		                $("#sumRaised").text((data[0][0]+data[0][1]).toFixed(2));
		            }
		            if(data[1].length!=0) { // Modem last updated
		                $("#lupdated").text(moment(data[1], "YYYY-MM-DD HH:mm:ss").fromNow());
		            }
			        if(data[2].length!=0) {
			            console.table(data[2]);
			            setCurrentPos(data[2][data[2].length-1]);
			            drawTail(data[2]);
			            latest_id=data[2][data[2].length-1].id;
			            map.setView([data[2][data[2].length-1].lat,data[2][data[2].length-1].lon],12);
			        }
		        }
	        });
        }
        
        function refreshData() {
            $.ajax({
		        url: "/data.php",
		        type: "GET",
		        dataType: 'json',
		        data: {
		            since_id: latest_id
		        },
		        success: function( data ) {
		            if(data[0].length!=0) { // Raised so far values
		                $("#scarlettRaised").text(data[0][0].toFixed(2));
		                $("#mohitRaised").text(data[0][1].toFixed(2));
		                $("#sumRaised").text((data[0][0]+data[0][1]).toFixed(2));
		            }
		            if(data[1].length!=0) { // Modem last updated
		                $("#lupdated").text(moment(data[1], "YYYY-MM-DD HH:mm:ss").fromNow());
		            }
			        if(data[2].length!=0) {
			            console.table(data[2]);
			            setCurrentPos(data[2][data[2].length-1]);
			            drawTail(data[2]);
			            latest_id=data[2][data[2].length-1].id;
			            map.panTo([data[2][data[2].length-1].lat,data[2][data[2].length-1].lon]);
			        }
		        }
	        });
        }
        
        function setCurrentPos(row) {
            if(lastMarker) {
            	lastMarker.closePopup();
                lastMarker.setLatLng([row['lat'],row['lon']]);
                lastMarker.bindPopup("Updated: "+row['t']+"<br>Speed: "+Math.round(row['spd'])+" mph");
                lastMarker.update();
            } else {
                lastMarker = L.marker([row['lat'],row['lon']], {
                    title: "Scarlett & Mohit",
                    icon: sillyDragonIcon
                }).addTo(map);
                lastMarker.bindPopup("Updated: "+row['t']+"<br>Speed: "+Math.round(row['spd'])+" mph");
            }
            
        }
       
        function drawTail(allRows) {
            var allLength = allRows.length;
            if(trackTail) {
                for (var i=0; i<allLength; i++) {
                    trackTail.addLatLng(new L.LatLng(allRows[i].lat, allRows[i].lon));
                }
            } else {
                var temp_latlngs = [];
                for (var i=0; i<allLength; i++) {
                    temp_latlngs.push(new L.LatLng(allRows[i].lat, allRows[i].lon));
                }
                trackTail = L.polyline(temp_latlngs, {color: 'red', opacity: 0.8}).addTo(map);
            }
        }
    </script> 
</body>
</html>

